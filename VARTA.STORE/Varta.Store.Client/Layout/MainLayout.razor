@inherits LayoutComponentBase
@using Blazored.LocalStorage
@using Varta.Store.Client.Auth
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager NavManager
@inject ILocalStorageService LocalStorage
@inject AuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar
@inject HttpClient Http
@inject ICartService CartService
@using Varta.Store.Client.Services

<MudThemeProvider IsDarkMode="true" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />

<MudLayout>
    <MudAppBar Elevation="0" Fixed="true" Class="blur-navbar px-8" Style="z-index: 2000;">
        <MudIcon Icon="@Icons.Material.Filled.Shield" Color="Color.Warning" Size="Size.Large" Class="mr-2"/>
        <MudText Typo="Typo.h5" Style="font-weight: 900; letter-spacing: 2px; cursor: pointer; margin-right: 60px;"
                 @onclick='() => NavManager.NavigateTo("/")'>
            VARTA
        </MudText>

        <MudHidden Breakpoint="Breakpoint.MdAndDown">
            <MudButton Variant="Variant.Text" Color="Color.Inherit" Class="nav-link mx-2"
                       OnClick='() => NavManager.NavigateTo("/")'>
                ГОЛОВНА
            </MudButton>

            <MudButton Variant="Variant.Text" Color="Color.Inherit" Class="nav-link mx-2"
                       OnClick='() => NavManager.NavigateTo("/info")'>
                ІНФО
            </MudButton>

            <MudButton Variant="Variant.Text" Color="Color.Inherit" Class="nav-link mx-2"
                       OnClick='() => NavManager.NavigateTo("/servers")'>
                СЕРВЕРИ
            </MudButton>

            <MudButton Variant="Variant.Text" Color="Color.Inherit" Class="nav-link mx-2"
                       OnClick='() => NavManager.NavigateTo("/store")'>
                МАГАЗИН
            </MudButton>

            <MudSpacer />

            <AuthorizeView Roles="Admin">
                <MudButton Variant="Variant.Text" Color="Color.Warning" Class="nav-link mx-2"
                           OnClick='() => NavManager.NavigateTo("/admin")'>
                    АДМІН ПАНЕЛЬ
                </MudButton>
            </AuthorizeView>

            <MudBadge Content="_cartCount" Color="Color.Error" Overlap="true" Class="mx-2" Visible="@(_cartCount > 0)">
                <MudIconButton Icon="@Icons.Material.Filled.ShoppingCart" Color="Color.Inherit" 
                               OnClick='() => NavManager.NavigateTo("/cart")' />
            </MudBadge>

            @* Authentication Section *@
            <AuthorizeView Context="auth">
                <Authorized>
                    <div class="d-flex align-center gap-4 ml-4">
                        @* 1. Balance Display *@
                        <div class="d-flex flex-column align-end">
                            <MudText Typo="Typo.caption" Style="color: #9e9eae; line-height: 1;">Баланс</MudText>
                            <MudText Typo="Typo.body1" Color="Color.Warning" Style="font-weight: 900;">
                                @BalanceService.CurrentBalance.ToString("F2") ₴
                            </MudText>
                        </div>

                        @* 2. User Avatar (clickable to go to profile) *@
                        <MudTooltip Text="Мій Профіль">
                            <MudBadge Overlap="true" Color="Color.Success" Dot="true" Bordered="true">
                                <MudAvatar Style="border: 2px solid #ff9800; cursor: pointer;" @onclick='() => NavManager.NavigateTo("/profile")'>
                                    <MudImage Src="@auth.User.FindFirst("AvatarUrl")?.Value" Alt="Avatar" />
                                </MudAvatar>
                            </MudBadge>
                        </MudTooltip>

                        @* 3. Logout Button to the right of avatar *@
                        <MudButton Variant="Variant.Outlined" 
                                   Color="Color.Error" 
                                   Size="Size.Small"
                                   OnClick="Logout"
                                   StartIcon="@Icons.Material.Filled.Logout"
                                   Style="text-transform: uppercase; font-weight: bold;">
                            Вийти
                        </MudButton>
                    </div>
                </Authorized>
                <NotAuthorized>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Warning"
                               Size="Size.Small"
                               Class="ml-6 px-4 rounded-pill"
                               StartIcon="@Icons.Custom.Brands.Steam"
                               Href="@($"{Http.BaseAddress}api/auth/login")"> LOGIN VIA STEAM
                    </MudButton>
                </NotAuthorized>
            </AuthorizeView>
        </MudHidden>

        <MudHidden Breakpoint="Breakpoint.LgAndUp">
            <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.End" />
        </MudHidden>
    </MudAppBar>

    <MudMainContent Class="pt-0">
        <div class="d-flex flex-column" style="min-height: 100vh;">
            <div class="flex-grow-1">
                @Body
            </div>
            <Varta.Store.Client.Layout.MainFooter />
        </div>
    </MudMainContent>
</MudLayout>

@inject IBalanceService BalanceService
@inject IProfileService ProfileService

@* ... imports ... *@

@code {
    private int _cartCount = 0;

    protected override async Task OnInitializedAsync()
    {
        _cartCount = await CartService.GetCartCount();
        CartService.OnChange += UpdateUI;
        BalanceService.OnChange += UpdateUI;
        
        // Initial balance sync
        await SyncBalance();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Double check balance after render if needed or rely on OnInitialized
            // However, OnInitialized runs once. If user logs in later, we need to detect that.
            // But MainLayout wraps everything.
            // Ideally, CustomAuthStateProvider should also trigger a balance fetch?
            // Or we just rely on the claim initially.
        }
    }

    private async Task SyncBalance()
    {
        // Try to get latest balance from profile if logged in
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity?.IsAuthenticated == true)
        {
            var claimBalance = authState.User.FindFirst("Balance")?.Value;
            if (decimal.TryParse(claimBalance, out var b))
            {
                 // Set initial from claim to avoid flicker
                 if (BalanceService.CurrentBalance == 0) BalanceService.SetBalance(b);
            }

            try 
            {
                // Fetch fresh from API to be sure
                var profile = await ProfileService.GetProfileAsync();
                if (profile != null)
                {
                    BalanceService.SetBalance(profile.Balance);
                }
            }
            catch {}
        }
    }

    private void UpdateUI()
    {
         Task.Run(async () => 
        {
            _cartCount = await CartService.GetCartCount();
            await InvokeAsync(StateHasChanged);
        });
    }

    public void Dispose()
    {
        CartService.OnChange -= UpdateUI;
        BalanceService.OnChange -= UpdateUI;
    }

    private async Task Logout()
    {
        await LocalStorage.RemoveItemAsync("authToken");

        if (AuthStateProvider is CustomAuthStateProvider customProvider)
        {
            customProvider.NotifyUserLogout();
        }

        Snackbar.Add("Ви вийшли з аккаунту", Severity.Info);
        NavManager.NavigateTo("/", true);
    }
}

<style>
    .blur-navbar {
        background-color: rgba(30, 30, 45, 0.9) !important;
        backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(255,255,255,0.05);
        transition: background-color 0.3s;
    }
    .nav-link { font-weight: bold; letter-spacing: 1px; }
    body { background-color: #121212; margin: 0; }
</style>