@inherits LayoutComponentBase
@using Blazored.LocalStorage
@using Varta.Store.Client.Auth
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager NavManager
@inject ILocalStorageService LocalStorage
@inject AuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar
@inject HttpClient Http

<MudThemeProvider IsDarkMode="true" />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="0" Fixed="true" Class="blur-navbar px-8" Style="z-index: 2000;">
        <MudIcon Icon="@Icons.Material.Filled.Shield" Color="Color.Warning" Size="Size.Large" Class="mr-2"/>
        <MudText Typo="Typo.h5" Style="font-weight: 900; letter-spacing: 2px; cursor: pointer;"
                 @onclick='() => NavManager.NavigateTo("/")'>
            VARTA
        </MudText>

        <MudSpacer />

        <MudHidden Breakpoint="Breakpoint.MdAndDown">
            <MudButton Variant="Variant.Text" Color="Color.Inherit" Class="nav-link mx-2"
                       OnClick='() => NavManager.NavigateTo("/")'>
                ГОЛОВНА
            </MudButton>

            <MudButton Variant="Variant.Text" Color="Color.Inherit" Class="nav-link mx-2"
                       OnClick='() => NavManager.NavigateTo("/store")'>
                МАГАЗИН
            </MudButton>

            @* Authentication Section *@
            <AuthorizeView Context="auth">
                <Authorized>
                    <div class="d-flex align-center gap-4 ml-4">
                        @* 1. Balance Display *@
                        <div class="d-flex flex-column align-end">
                            <MudText Typo="Typo.caption" Style="color: #9e9eae; line-height: 1;">Баланс</MudText>
                            <MudText Typo="Typo.body1" Color="Color.Warning" Style="font-weight: 900;">
                                @auth.User.FindFirst("Balance")?.Value ₴
                            </MudText>
                        </div>

                        @* 2. User Avatar (without menu now, just display) *@
                        <MudBadge Overlap="true" Color="Color.Success" Dot="true" Bordered="true">
                            <MudAvatar Style="border: 2px solid #ff9800;">
                                <MudImage Src="@auth.User.FindFirst("AvatarUrl")?.Value" Alt="Avatar" />
                            </MudAvatar>
                        </MudBadge>

                        @* 3. Logout Button to the right of avatar *@
                        <MudButton Variant="Variant.Outlined" 
                                   Color="Color.Error" 
                                   Size="Size.Small"
                                   OnClick="Logout"
                                   StartIcon="@Icons.Material.Filled.Logout"
                                   Style="text-transform: uppercase; font-weight: bold;">
                            Вийти
                        </MudButton>
                    </div>
                </Authorized>
                <NotAuthorized>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Warning"
                               Size="Size.Small"
                               Class="ml-6 px-4 rounded-pill"
                               StartIcon="@Icons.Custom.Brands.Steam"
                               Href="@($"{Http.BaseAddress}api/auth/login")"> LOGIN VIA STEAM
                    </MudButton>
                </NotAuthorized>
            </AuthorizeView>
        </MudHidden>

        <MudHidden Breakpoint="Breakpoint.LgAndUp">
            <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.End" />
        </MudHidden>
    </MudAppBar>

    <MudMainContent Class="pt-0">
        <div class="d-flex flex-column" style="min-height: 100vh;">
            <div class="flex-grow-1">
                @Body
            </div>
            <Varta.Store.Client.Layout.MainFooter />
        </div>
    </MudMainContent>
</MudLayout>

@code {
    private async Task Logout()
    {
        await LocalStorage.RemoveItemAsync("authToken");

        if (AuthStateProvider is CustomAuthStateProvider customProvider)
        {
            customProvider.NotifyUserLogout();
        }

        Snackbar.Add("Ви вийшли з аккаунту", Severity.Info);
        NavManager.NavigateTo("/", true);
    }
}

<style>
    .blur-navbar {
        background-color: rgba(30, 30, 45, 0.9) !important;
        backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(255,255,255,0.05);
        transition: background-color 0.3s;
    }
    .nav-link { font-weight: bold; letter-spacing: 1px; }
    body { background-color: #121212; margin: 0; }
</style>