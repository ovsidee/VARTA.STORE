@inherits LayoutComponentBase
@using Blazored.LocalStorage
@using Varta.Store.Client.Auth
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager NavManager
@inject ILocalStorageService LocalStorage
@inject AuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar
@inject HttpClient Http
@inject ICartService CartService
@using Varta.Store.Client.Services
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<App> Localizer

<MudThemeProvider IsDarkMode="true" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />

<MudLayout>
    <MudAppBar Elevation="0" Fixed="true" Class="blur-navbar px-8" Style="z-index: 1100;">
        <MudIcon Icon="@Icons.Material.Filled.Shield" Color="Color.Warning" Size="Size.Large" Class="mr-2" />
        <MudText Typo="Typo.h5" Style="font-weight: 900; letter-spacing: 2px; cursor: pointer; margin-right: 60px;"
        @onclick='() => NavManager.NavigateTo("/")'>
            @Localizer["Home_Title"]
        </MudText>

        <MudHidden Breakpoint="Breakpoint.MdAndDown">
            <MudButton Variant="Variant.Text" Color="Color.Inherit" Class="nav-link mx-2"
                OnClick='() => NavManager.NavigateTo("/")'>
                @Localizer["Nav_Home"]
            </MudButton>

            <MudButton Variant="Variant.Text" Color="Color.Inherit" Class="nav-link mx-2"
                OnClick='() => NavManager.NavigateTo("/info")'>
                @Localizer["Nav_Info"]
            </MudButton>

            <MudButton Variant="Variant.Text" Color="Color.Inherit" Class="nav-link mx-2"
                OnClick='() => NavManager.NavigateTo("/rules")'>
                @Localizer["Nav_Rules"]
            </MudButton>

            <MudButton Variant="Variant.Text" Color="Color.Inherit" Class="nav-link mx-2"
                OnClick='() => NavManager.NavigateTo("/servers")'>
                @Localizer["Nav_Servers"]
            </MudButton>

            <MudButton Variant="Variant.Text" Color="Color.Inherit" Class="nav-link mx-2"
                OnClick='() => NavManager.NavigateTo("/store")'>
                @Localizer["Nav_Store"]
            </MudButton>

            <MudSpacer />

            <AuthorizeView Roles="Admin">
                <MudButton Variant="Variant.Text" Color="Color.Warning" Class="nav-link mx-2"
                    OnClick='() => NavManager.NavigateTo("/admin")'>
                    @Localizer["Nav_Admin"]
                </MudButton>
            </AuthorizeView>

            <!-- Culture Selector -->
            <div class="mx-2">
                <CultureSelector />
            </div>

            <MudBadge Content="_cartCount" Color="Color.Error" Overlap="true" Class="mx-2" Visible="@(_cartCount > 0)">
                <MudIconButton Icon="@Icons.Material.Filled.ShoppingCart" Color="Color.Inherit"
                    OnClick='() => NavManager.NavigateTo("/cart")' />
            </MudBadge>

            @* Authentication Section *@
            <AuthorizeView Context="auth">
                <Authorized>
                    <div class="d-flex align-center gap-4 ml-4">
                        @* 1. Balance Display *@
                        <div class="d-flex flex-column align-end">
                            <MudText Typo="Typo.caption" Style="color: #9e9eae; line-height: 1;">
                                @Localizer["Nav_Balance"]</MudText>
                            <MudText Typo="Typo.body1" Color="Color.Warning" Style="font-weight: 900;">
                                @BalanceService.CurrentBalance.ToString("F2") ₴
                            </MudText>
                        </div>

                        @* 2. User Avatar (clickable to go to profile) *@
                        <MudTooltip Text="@Localizer["Nav_MyProfile"]">
                            <MudBadge Overlap="true" Color="Color.Success" Dot="true" Bordered="true">
                                <MudAvatar Style="border: 2px solid #ff9800; cursor: pointer;"
                                @onclick='() => NavManager.NavigateTo("/profile")'>
                                    <MudImage Src="@auth.User.FindFirst("AvatarUrl")?.Value" Alt="Avatar" />
                                </MudAvatar>
                            </MudBadge>
                        </MudTooltip>

                        @* 3. Logout Button to the right of avatar *@
                        <MudButton Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small" OnClick="Logout"
                            StartIcon="@Icons.Material.Filled.Logout"
                            Style="text-transform: uppercase; font-weight: bold;">
                            @Localizer["Button_Logout"]
                        </MudButton>
                    </div>
                </Authorized>
                <NotAuthorized>
                    <MudButton Variant="Variant.Filled" Color="Color.Warning" Size="Size.Small"
                        Class="ml-6 px-4 rounded-pill" StartIcon="@Icons.Custom.Brands.Steam"
                        Href="@($"{Http.BaseAddress}api/auth/login")"> @Localizer["Button_Login"]
                    </MudButton>
                </NotAuthorized>
            </AuthorizeView>
        </MudHidden>

        <MudHidden Breakpoint="Breakpoint.LgAndUp">
            <div class="mx-2">
                <CultureSelector />
            </div>
            <MudBadge Content="_cartCount" Color="Color.Error" Overlap="true" Class="mx-2" Visible="@(_cartCount > 0)">
                <MudIconButton Icon="@Icons.Material.Filled.ShoppingCart" Color="Color.Inherit" Edge="Edge.End"
                    OnClick='() => NavManager.NavigateTo("/cart")' />
            </MudBadge>
            <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.End"
                OnClick="@((e) => DrawerToggle())" />
        </MudHidden>
    </MudAppBar>

    <MudDrawer @bind-Open="@_drawerOpen" Anchor="Anchor.Right" Elevation="2" Variant="@DrawerVariant.Temporary"
        Class="mud-theme-dark" Style="background-color: #1e1e2d;">
        <MudDrawerHeader Class="d-flex align-center justify-space-between px-4 py-4">
            <MudText Typo="Typo.h5" Style="font-weight: 900; letter-spacing: 2px;">@Localizer["Home_Title"]</MudText>
            <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Inherit"
                OnClick="@((e) => DrawerToggle())" />
        </MudDrawerHeader>
        <MudNavMenu Class="pt-4">
            <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home">@Localizer["Nav_Home"]
            </MudNavLink>
            <MudNavLink Href="/info" Icon="@Icons.Material.Filled.Info">@Localizer["Nav_Info"]</MudNavLink>
            <MudNavLink Href="/rules" Icon="@Icons.Material.Filled.Gavel">@Localizer["Nav_Rules"]</MudNavLink>
            <MudNavLink Href="/servers" Icon="@Icons.Material.Filled.Dns">@Localizer["Nav_Servers"]</MudNavLink>
            <MudNavLink Href="/store" Icon="@Icons.Material.Filled.Store">@Localizer["Nav_Store"]</MudNavLink>
            <MudNavLink Href="/cart" Icon="@Icons.Material.Filled.ShoppingCart">
                @Localizer["Nav_Cart"] @(_cartCount > 0 ? $"({_cartCount})" : "")
            </MudNavLink>

            <AuthorizeView Roles="Admin">
                <MudNavLink Href="/admin" Icon="@Icons.Material.Filled.AdminPanelSettings" IconColor="Color.Warning">
                    @Localizer["Nav_Admin"]</MudNavLink>
            </AuthorizeView>

            <MudDivider Class="my-4" />

            <AuthorizeView>
                <Authorized>
                    <MudNavLink Href="/profile" Icon="@Icons.Material.Filled.Person">@Localizer["Nav_Profile"]
                    </MudNavLink>
                    <MudNavLink OnClick="Logout" Icon="@Icons.Material.Filled.Logout" IconColor="Color.Error">
                        @Localizer["Nav_Logout"]
                    </MudNavLink>
                </Authorized>
                <NotAuthorized>
                    <MudNavLink Href="api/auth/login" Icon="@Icons.Custom.Brands.Steam" IconColor="Color.Info">
                        @Localizer["Nav_Login"]</MudNavLink>
                </NotAuthorized>
            </AuthorizeView>
        </MudNavMenu>
    </MudDrawer>

    <MudMainContent Class="pt-0">
        <div class="d-flex flex-column" style="min-height: 100vh;">
            <div class="flex-grow-1">
                @Body
            </div>
            <Varta.Store.Client.Layout.MainFooter />
        </div>
    </MudMainContent>
</MudLayout>

@inject IBalanceService BalanceService
@inject IProfileService ProfileService

@* ... imports ... *@

@code {
    private int _cartCount = 0;
    private bool _drawerOpen = false;

    private void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    protected override async Task OnInitializedAsync()
    {
        _cartCount = await CartService.GetCartCount();
        CartService.OnChange += UpdateUI;
        BalanceService.OnChange += UpdateUI;

        // Initial balance sync
        await SyncBalance();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Double check balance after render if needed or rely on OnInitialized
            // However, OnInitialized runs once. If user logs in later, we need to detect that.
            // But MainLayout wraps everything.
            // Ideally, CustomAuthStateProvider should also trigger a balance fetch?
            // Or we just rely on the claim initially.
        }
    }

    private async Task SyncBalance()
    {
        // Try to get latest balance from profile if logged in
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity?.IsAuthenticated == true)
        {
            var claimBalance = authState.User.FindFirst("Balance")?.Value;
            if (decimal.TryParse(claimBalance, out var b))
            {
                // Set initial from claim to avoid flicker
                if (BalanceService.CurrentBalance == 0) BalanceService.SetBalance(b);
            }

            try
            {
                // Fetch fresh from API to be sure
                var profile = await ProfileService.GetProfileAsync();
                if (profile != null)
                {
                    BalanceService.SetBalance(profile.Balance);
                }
            }
            catch { }
        }
    }

    private void UpdateUI()
    {
        Task.Run(async () =>
        {
            _cartCount = await CartService.GetCartCount();
            await InvokeAsync(StateHasChanged);
        });
    }

    public void Dispose()
    {
        CartService.OnChange -= UpdateUI;
        BalanceService.OnChange -= UpdateUI;
    }

    private async Task Logout()
    {
        await LocalStorage.RemoveItemAsync("authToken");

        if (AuthStateProvider is CustomAuthStateProvider customProvider)
        {
            customProvider.NotifyUserLogout();
        }

        Snackbar.Add(Localizer["Message_LoggedOut"], Severity.Info);
        NavManager.NavigateTo("/", true);
    }
}

<style>
    .blur-navbar {
        background-color: rgba(30, 30, 45, 0.9) !important;
        backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        transition: background-color 0.3s;
    }

    .nav-link {
        font-weight: bold;
        letter-spacing: 1px;
    }

    body {
        background-color: #121212;
        margin: 0;
    }
</style>